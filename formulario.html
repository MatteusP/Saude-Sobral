<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário</title>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .meu-card {
            min-width: 400px;
            max-width: 1000px;
            margin: auto;
            background-color: white;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0px 0px 20px rgba(70, 68, 68, 0.233);
        }
    </style>

    <script>
        function mascara_cpf() {
            var cpf = document.getElementById('cpf')
            if (cpf.value.length == 3 || cpf.value.length == 7) {
                cpf.value += "."
            } else if (cpf.value.length == 11) {
                cpf.value += "-"
            }
        }

    </script>
    <script>
        function deletar() {
            window.localStorage.clear()
            document.location.reload(true)
        }
    </script>
</head>

<body>

    <main class="meu-card">
        <section class="container">
            <div class="row">
                <h4><i class="small material-icons">assignment_ind</i>Dados Pessoais</h4>
                <article>
                    <!--<form>-->
                        <div class="input-field col s6">
                            <input placeholder="CPF" type="text" name='cpf' id='cpf' autocomplete="off" maxlength="14"
                                onkeydown="mascara_cpf()" required />
                            <label for='cpf'>CPF</label>
                        </div>

                        <div class="input-field col s6">
                            <input class='validate' type="text" name='cadsus' id='cadsus' required />
                            <label for='cadsus'>cadSUS</label>
                        </div>

                        <div class="input-field col s12">
                            <input class='validate' type="text" name='nome' id='nome' required />
                            <label for='nome'>Nome Completo</label>
                        </div>

                        <div class="input-field col s4">
                            <input class='validate' type="date" name='dataN' id='dataN' required />
                            <label for='dataN'>Data de Nascimento</label>
                        </div>

                        <div class="input-field col s4">
                            <select class="browser-default" id="sexo" name="sexo">
                                <option value="" disabled selected>Sexo</option>
                                <option value="masculino">Masculino</option>
                                <option value="feminino0">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>

                        <div class="input-field col s4">
                            <select class="browser-default" id="cor" name="cor">
                                <option value="" disabled selected>Cor</option>
                                <option value="amarelo">Amarelo</option>
                                <option value="branco">Branco</option>
                                <option value="pardo">Pardo</option>
                                <option value="preto">Preto</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>

                        <div class="input-field col s12">
                            <input class='validate' type="text" name='nomeM' id='nomeM' required />
                            <label for='nomeM'>Nome da Mãe</label>

                        </div>

                        <div class="input-field col s4">
                            <label>
                                <input type="checkbox" id="maedesc" value="Mãe desconhecida" />
                                <span>Mãe Deseconhecida</span>
                                <br>
                            </label>
                        </div>

                        <div class="input-field col s12">
                            <input class='validate' type="text" name='nomeP' id='nomeP' required />
                            <label for='nomeP'>Nome do Pai</label>
                        </div>

                        <div class="input-field col s12">

                            <label>
                                <input type="checkbox" id="paidesc" value="Pai desconhecido" />
                                <span>Pai Deseconhecido</span>
                            </label>
                        </div>

                        <div class="input-field col s6">
                            <br>
                            <select class="browser-default" id="txtEstadoNasc">
                                <option value="" disabled selected>Selecione o Estado</option>
                            </select>
                        </div>

                        <div class="input-field col s5">
                            <br>
                            <select id="cidadeNasc" class="browser-default">
                                <option value=" " selected disabled> Selecione o Estado</option>
                            </select>
                        </div>

                        <div class="input-field col s12">
                            <label>
                                <input name="faleceu" type="checkbox" />
                                <span>Faleceu?</span>
                            </label>
                        </div>

                        <div class="input-field col s5">
                            <br>
                            <button class="waves-effect grey darken-3 btn" onclick="salvarDados()"><i
                                    class="material-icons right"></i>Enviar</button>
                        </div>

                        <div class="input-field col s4">
                            <br>
                            <a class="waves-effect grey darken-3 btn" value="limpar" class="butt"
                                onclick="deletar()">Limpar Formulário</a>

                        </div>
                    <!--</form>-->
                </article>
        </section>
        <!--Listagem de Pessoas-->
        <section class="container">
            <div class="row">
                <h4><i class="small material-icons">assignment_ind</i>Pessoas Cadastradas</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Data de Nascimento</th>
                        </tr>
                    </thead>
                    <tbody id="lista-pessoas">
                        <tr>
                            <td colspan="4">Sem Registros</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!--Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>

        $(document).ready(function () {
            if (localStorage.getItem('token')) {
                validarUsuario(localStorage.getItem('token'))
            } else {
                alert('Não Autenticado')
                //Redirecionar pro login
                window.location = "login.html"
            }

            listarPessoas(localStorage.getItem('token'))

            $.ajax({
                url: 'http://172.16.34.244:1500/api/uf',
                success: function (response) {
                    const ufs = response;
                    $('#txtEstadoNasc').html('<option value="" disabled selected>Selecione o Estado</option>');
                    $.each(ufs, function (index, uf) {
                        $('#txtEstadoNasc').append(`
                            <option name="estado" value="${uf.id}"> ${uf.uf_full_name} (${uf.uf}) </option>
                        `);
                    })
                },
                error: function (erro) {
                    alert('Ocorreu o erro? ' + erro);
                }
            });
        });

        $("#txtEstadoNasc").change(function () {
            getCitysByuf($("#txtEstadoNasc").val());
        })

        const getCitysByuf = (uf_id) => {
            $.ajax({
                url: 'http://172.16.34.244:1500/api/city',
                data: { "uf_id": uf_id },
                success: function (response) {
                    const citys = response.data;
                    $('#cidadeNasc').html('<option value="" disabled selected>Selecione a Cidade</option>');
                    $.each(citys, function (index, city) {
                        $('#cidadeNasc').append(`
                            <option name="estado" value="${city.id}"> ${city.city} </option>
                        `);
                    })
                },
                error: function (erro) {
                    alert('Ocorreu o erro? ' + erro);
                }
            });
        }


        const validarUsuario = (token) => {
            $.ajax({
                url: 'http://172.16.34.244:1500/api/user',
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                success: function (response) {
                    console.log('Validação de acesso', response)
                },
                error: function (erro) {
                    alert('Não Autenticado')
                    //Redirecionar pro login
                    window.location = "login.html"
                }
            });
        }
        //listar as pessoas já cadastradas
        const listarPessoas = (token) => {
            $.ajax({
                url: 'http://172.16.34.244:1500/api/people/show',
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                success: function (response) {
                    console.log('Lista de pessoas', response)
                    $("#lista-pessoas").html("")
                    $.each(response[0], (index, value) => {
                        console.log("Indice", index)
                        console.log("Valor", value)
                        $("#lista-pessoas").append(`
                            <tr>
                                <td>${value.name}</td> 
                                <td>${value.cpf}</td>
                                <td>${value.birthdate}</td>
                                <td></td>
                            </tr>
                        `)
                    })
                },
                error: function (erro) {
                    alert('Ocorreu o erro? ' + erro);
                }
            });
        }
        //Adicionar dados de uma pessoa no array
        function salvarDados() {
            let name = $("#nome").val()
            let cpf = $("#cpf").val()
            let birthdate = $("#dataN").val().split('/')
            birthdate = birthdate[1] + "-" + birthdate[0] + "-" + birthdate[2]
            let cadsus = $("#cadsus").val()
            let sexo = $("#sexo").val()
            let ethnicity = $("#cor").val()
            let uf_id = $("#txtEstadoNasc").val()
            let city_id = $("#cidadeNasc").val()
            
            const token = localStorage.getItem('token')

            $.ajax({
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                url: 'http://172.16.34.244:1500/api/people/create',
                //timeout: 1000,
                data: JSON.stringify({
                    name: `${name}`,
                    cpf: `${cpf}`,
                    birthdate: `${birthdate}`,
                    cadsus: `${cadsus}`,
                    sexo: `${sexo}`,
                    ethnicity: `${ethnicity}`,
                    uf_id: `${uf_id}`,
                    city_id: `${city_id}`

                }),
                beforeSend: function() {
                    console.log('Salvando dados usuario')
                },
                success: function (response) {
                    console.log('Resposta registro usuário', response)
                },
                error: function (error) {
                    alert('Ocorreu o erro: ' + error)
                }
            })

        }

    </script>

</body>

</html>